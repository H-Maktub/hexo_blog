[{"title":"openwrt之shadowsock做PAC代理","url":"/pages/23da3085/","content":"安装配置shadowsocks+ChinaDNS+dns-forwarder添加软件源\n添加证书\n\nwget http://openwrt-dist.sourceforge.net/openwrt-dist.pubopkg-key add openwrt-dist.pub\n\n编辑/etc/opkg/customfeeds.conf,添加软件源\n\nsrc/gz openwrt_dist http://openwrt-dist.sourceforge.net/packages/base/x86_64src/gz openwrt_dist_luci http://openwrt-dist.sourceforge.net/packages/luci\n\n在线安装opkg updateopkg install ChinaDNSopkg install luci-app-chinadnsopkg install dns-forwarderopkg install luci-app-dns-forwarderopkg install shadowsocks-libevopkg install luci-app-shadowsocks\n\n离线安装opkg updatewget http://openwrt-dist.sourceforge.net/packages/base/x86_64/ChinaDNS_1.3.3-1_x86_64.ipkopkg install ChinaDNS_1.3.3-1_x86_64.ipk wget http://openwrt-dist.sourceforge.net/packages/base/x86_64/dns-forwarder_1.2.1-2_x86_64.ipkopkg install dns-forwarder_1.2.1-2_x86_64.ipkwget http://openwrt-dist.sourceforge.net/packages/base/x86_64/shadowsocks-libev_3.3.4-1_x86_64.ipkopkg install shadowsocks-libev_3.3.4-1_x86_64.ipkopkg install luci-app-chinadnsopkg install luci-app-dns-forwarderopkg install luci-app-shadowsocks\n\n配置shadowsocks添加服务器\n设置 \n访问控制\n配置ChinaDNS\n配置dns-forwarder\n安装配置HTTP代理privoxy(可选)安装opkg install privoxy opkg install luci-app-privoxy opkg install luci-i18n-privoxy-zh-cn\n\n配置 方式一（注意先，先配置好再启动）\n配置 方式二编辑/etc/config/privoxyconfig privoxy &#x27;privoxy&#x27;        option confdir &#x27;/etc/privoxy&#x27;        option logdir &#x27;/var/log&#x27;        option logfile &#x27;privoxy.log&#x27;        list filterfile &#x27;default.filter&#x27;        list actionsfile &#x27;match-all.action&#x27;        list actionsfile &#x27;default.action&#x27;        list listen_address &#x27;0.0.0.0:8118&#x27;        option toggle &#x27;1&#x27;        option enable_remote_toggle &#x27;1&#x27;        option enable_edit_actions &#x27;1&#x27;        option forwarded_connect_retries &#x27;0&#x27;        option keep_alive_timeout &#x27;300&#x27;        option debug_512 &#x27;1&#x27;        option debug_4096 &#x27;1&#x27;        option debug_8192 &#x27;1&#x27;        list forward_socks5 &#x27;/ 127.0.0.1:1080    .&#x27;        list forward &#x27;192.168.*.*/      .&#x27;        list forward &#x27;127.*.*.*/        .&#x27;        list forward &#x27;10.*.*.*/ .&#x27;        list forward &#x27;localhost/ .&#x27;config system &#x27;system&#x27;        option boot_delay &#x27;5&#x27;\n\n配置PAC文件安装pipopkg install python3-pip\n\n安装genpacpip install genpac\n\n生成SOCKS5代理方式genpac --proxy=&quot;SOCKS5 192.168.3.2:1080&quot; --gfwlist-proxy=&quot;SOCKS5 192.168.3.2:1080&quot; -o /www/gfwlist.pac\n\n生成HTTP代理方式genpac --proxy=&quot;SOCKS5 192.168.3.2:1080&quot; --gfwlist-proxy=&quot;PROXY 192.168.3.2:8118&quot; -o /www/gfwlist.pac\n\n自动更新配置新建脚本\n/etc/script/gen_pac.sh\n\n/usr/bin/genpac --proxy=&quot;SOCKS5 192.168.3.2:1080&quot; --gfwlist-proxy=&quot;SOCKS5 192.168.3.2:1080&quot; -o /www/gfwlist.pac\n\n\n/etc/script/gen_chnroute.sh\n\n/bin/wget -O- &#x27;http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest&#x27; | awk -F\\| &#x27;/CN\\|ipv4/ &#123; printf(&quot;%s/%d\\n&quot;, $4, 32-log($5)/log(2)) &#125;&#x27; &gt; /etc/chinadns_chnroute.txt\n\n更改权限系统 &gt;&gt; 计划任务\nchmod +x /etc/script/gen_pac.shchmod +x /etc/script/gen_chnroute.sh\n\n添加定时任务14  4  8  *  *  sh /etc/script/gen_chnroute.sh 14  4  8  *  *  sh /etc/script/gen_pac.sh \n\n使用macos系统\n参考文献\nopenwrt shadowsock 教程\ngenpac\n\n","categories":["软路由"],"tags":["openwrt","shadowsock","privoxy"]},{"title":"openwrt之zerotier异地组网","url":"/pages/98f6a1d6/","content":"安装opkg install zerotier\n\n配置zerotier编辑/etc/config/zerotierconfig zerotier sample_config        option enabled 1        option config_path &#x27;/etc/zerotier&#x27;        option secret &#x27;&#x27;        list join &#x27;填入自己网络id&#x27; \n\n启动服务mkdir /etc/zerotier/etc/init.d/zerotier start\n\n开机启动/etc/init.d/zerotier enable\n\n\n\nopenwrt添加网络接口\n配置zerotier\n登陆zerotier，配置ip\n配置zerotier路由(本人用的是192.168.9.100，请自行更改ip)\n\n配置openwrt防火墙\n添加基本防火墙设置\n添加自定义规则\n\niptables -I FORWARD -i ztr2qvners -j ACCEPTiptables -I FORWARD -o ztr2qvners -j ACCEPTiptables -t nat -I POSTROUTING -o ztr2qvners -j MASQUERADE\n\n说明\n配置完成后，可以用zerotier客户端连接家里的网络，但是网段不能和家里的网段一样，会冲突。\n\n参考文献\nZerotier官网\n\n","categories":["软路由"],"tags":["openwrt","zerotier"]},{"title":"openwrt之安装配置","url":"/pages/bc25ad93/","content":"环境\nMACOS 10.15\nESXI 6.7\n\n准备镜像文件转换brew install qemuqemu-img convert -f raw -O vmdk ~/Downloads/openwrt-19.07.0-x86-64-combined-ext4.img openwrt-19.07.0-x86-64-combined-ext4.vmdk\n\nEsxi镜像转换\n上传文件\n转换\n\nvmkfstools -i openwrt-19.07.0-x86-64-combined-ext4.vmdk openwrt.vmdk -d thin\n\n\n安装创建虚拟机\n配置作为旁路由设置IP\n修改/etc/config/network\n重启网络\n\n/etc/init.d/network reload\n\n登陆系统后配置网络\n\n如果作为旁路由，请关闭DHCP\n\n\n\n\n更新软件包列表opkg update\n\n安装中文包opkg install luci-i18n-base-zh-cnopkg install luci-i18n-firewall-zh-cn\n\n参考文献\nOpenWrt on VMware HowTo\nImage Files\n网络设置\n\n","categories":["软路由"],"tags":["openwrt"]},{"title":"openwrt之shadowsock服务器搭建","url":"/pages/64803281/","content":"环境\ndebian10\nshadowsocks-libev\n\n安装官方源安装sudo apt updatesudo apt install shadowsocks-libev\n\n官方源最新版本安装\n添加软件源，编辑/etc/apt/sources.list，添加：\n\ndeb http://deb.debian.org/debian buster-backports main\n\n安装\n\nsudo apt updatesudo apt-get -t buster-backports install &quot;shadowsocks-libev&quot;\n\n配置\n编辑配置文件 /etc/shadowsocks-libev/ssconfig.json\n\n&#123;    &quot;server&quot;:[&quot;::1&quot;, &quot;0.0.0.0&quot;],    &quot;mode&quot;:&quot;tcp_and_udp&quot;,    &quot;port_password&quot;: &#123;        &quot;port1&quot;: &quot;password1&quot;,        &quot;port2&quot;: &quot;password2&quot;,    &#125;,    &quot;timeout&quot;:60,    &quot;method&quot;:&quot;chacha20-ietf-poly1305&quot;,    &quot;fast_open&quot;:true&#125;\n\n\n创建系统服务/etc/systemd/system/ssmanager.service\n\n[Unit]Description=Shadowsocks Manager ServerAfter=network.target[Service]User=rootGroup=rootKillMode=mixedType=simpleExecStart=/usr/bin/ss-manager --manager-address /var/run/shadowsocks-manager.sock -c /etc/shadowsocks-libev/ssconfig.jsonExecReload=/bin/kill -s HUP $MAINPIDExecStop=/bin/kill -s QUIT $MAINPID[Install]WantedBy=multi-user.target\n\n开启服务\n\nsystemctl start ssmanagersystemctl enable ssmanager\n优化\n开启BBR\n\necho &quot;tcp_bbr&quot; | sudo tee --append /etc/modules-load.d/modules.conf\n\n优化内核，编辑/etc/sysctl.conf\n\nfs.file-max = 51200net.core.rmem_max = 67108864net.core.wmem_max = 67108864net.core.netdev_max_backlog = 250000net.core.somaxconn = 4096net.ipv4.tcp_syncookies = 1net.ipv4.tcp_tw_reuse = 1net.ipv4.tcp_tw_recycle = 0net.ipv4.tcp_fin_timeout = 30net.ipv4.tcp_keepalive_time = 1200net.ipv4.ip_local_port_range = 10000 65000net.ipv4.tcp_max_syn_backlog = 8192net.ipv4.tcp_max_tw_buckets = 5000net.ipv4.tcp_fastopen = 3net.ipv4.tcp_mem = 25600 51200 102400net.ipv4.tcp_rmem = 4096 87380 67108864net.ipv4.tcp_wmem = 4096 65536 67108864net.ipv4.tcp_mtu_probing = 1net.core.default_qdisc=fqnet.ipv4.tcp_congestion_control=bbr\n\n重启电脑后，检查是否开启bbr\n\n## 第一项检查：sysctl net.ipv4.tcp_available_congestion_control | grep bbr## 若已开启bbr，结果通常为以下两种：net.ipv4.tcp_available_congestion_control = bbr cubic renonet.ipv4.tcp_available_congestion_control = reno cubic bbr## 第二项检查：sysctl net.ipv4.tcp_congestion_control | grep bbr## 若已开启bbr，结果如下：net.ipv4.tcp_congestion_control = bbr## 第三项检查：sysctl net.core.default_qdisc | grep fq## 若已开启bbr，结果如下：net.core.default_qdisc = fq## 第四项检查：lsmod | grep bbr## 若已开启bbr，结果可能如下。并不是所有的 VPS 都会有此返回值，若没有也属正常。tcp_bbr 20480 2\n\n参考文献\nshadowsocks-libev\n\n快速搭建\noutline\n\n","categories":["软路由"],"tags":["shadowsock"]},{"title":"Esxi之kvm-opencore-bigsur黑苹果","url":"/pages/e72f4f4c/","content":"环境\ndebian server(无桌面)\nkvm虚拟机\n\n安装开启虚拟机的虚拟化echo 1 | sudo tee /sys/module/kvm/parameters/ignore_msrssudo cp kvm.conf /etc/modprobe.d/kvm.conf  ## for intel boxes\n\n安装软件sudo apt-get install qemu uml-utilities virt-manager git wget libguestfs-tools p7zip-full -y\n\n下载git clone https://github.com/kholia/OSX-KVM.gitcd OSX-KVM./fetch-macOS-v2.pyqemu-img convert BaseSystem.dmg -O raw BaseSystem.imgqemu-img create -f qcow2 mac_hdd_ng.img 256G\n\n无界面启动安装修改OpenCore-Boot.sh\n#安装完毕后屏蔽启动盘-device ide-hd,bus=sata.3,drive=InstallMedia-drive id=InstallMedia,if=none,file=&quot;$REPO_PATH/BaseSystem.img&quot;,format=raw#网络桥接或虚拟网络选择-netdev tap,id=net0,ifname=tap0,script=no,downscript=no -device vmxnet3,netdev=net0,id=net0,mac=52:54:00:c9:18:27#-netdev user,id=net0 -device vmxnet3,netdev=net0,id=net0,mac=52:54:00:c9:18:27#屏蔽，不然启动不了## -monitor stdio  #先使用-vga qxl进行安装-device VGA,vgamem_mb=128#-vga qxl#安装完毕后关闭vnc-nographic#-nographic -vnc :0 -k en-us\n\n\n\n网络配置操作参考下文Esxi之kvm安装黑苹果\n参考文献\nOSX-KVM\n\n","categories":["软路由"],"tags":["esxi","kvm","big sur"]},{"title":"Esxi之kvm安装黑苹果","url":"/pages/e20e97af/","content":"环境\ndebian server(无桌面)\nkvm虚拟机\n\n安装安装黑苹果\n安装依赖\n\nsudo apt-get install qemu-system qemu-utils python3 python3-pip\n\n\n下载git仓库macOS-Simple-KVM\n\ngit clone https://github.com/foxlet/macOS-Simple-KVM.git\n\n\n初始化镜像和初始化kvm硬盘(建议至少120G以上)\n\ncd macOS-Simple-KVM#可能会失败，重复到成功./jumpstart.shqemu-img create -f qcow2 MyDisk.qcow2 120G\n\n\n启动黑苹果\n\nHEADLESS=1 MEM=8G CPUS=4 SYSTEM_DISK=MyDisk.qcow2 ./headless.sh\n\n\n使用VNC软件连接debian服务器\n\n安装黑苹果\n\n先初始化硬盘，后安装镜像，初始化安装可能会失败，重复到可以为止\n\n\n\n桥接网络\n安装依赖\n\napt install bridge-utilsapt install uml-utilitiesapt install net-tools\n\n\n\n\n编辑启动脚本macos.sh\n\n#启动桥接网卡,ens192为物理网卡，请自行修改brctl addbr br0ip addr flush dev ens192brctl addif br0 ens192tunctl -t tap0 -u rootbrctl addif br0 tap0ifconfig ens192 upifconfig tap0 upifconfig br0 up#dhclient -v br0ifconfig br0 192.168.3.28 netmask 255.255.255.0route add default gw 192.168.3.1#启动黑苹果cd /root/macOS-Simple-KVMsh startmacos.sh \n\n\n复制headless.sh文件为startmacos.sh,并修改相关参数，以下为个人修改参考\n\n#!/bin/bashOSK=&quot;ourhardworkbythesewordsguardedpleasedontsteal(c)AppleComputerInc&quot;VMDIR=$PWDOVMF=$VMDIR/firmwareqemu-system-x86_64 \\    -enable-kvm \\    -m 12G \\    -machine q35,accel=kvm \\    -smp 4,cores=4  \\    -cpu Penryn,vendor=GenuineIntel,kvm=on,+sse3,+sse4.2,+aes,+xsave,+avx,+xsaveopt,+xsavec,+xgetbv1,+avx2,+bmi2,+smep,+bmi1,+fma,+movbe,+invtsc \\    -device isa-applesmc,osk=&quot;$OSK&quot; \\    -smbios type=2 \\    -drive if=pflash,format=raw,readonly,file=&quot;$OVMF/OVMF_CODE.fd&quot; \\    -drive if=pflash,format=raw,file=&quot;$OVMF/OVMF_VARS-1024x768.fd&quot; \\    -vga qxl \\    -usb -device usb-kbd -device usb-tablet \\    -netdev tap,id=net0,ifname=tap0,script=no,downscript=no \\    -device vmxnet3,netdev=net0,id=net0,mac=52:54:00:0e:0d:20 \\    -device ich9-ahci,id=sata \\    -drive id=ESP,if=none,format=qcow2,file=ESP.qcow2 \\    -device ide-hd,bus=sata.2,drive=ESP \\    -drive id=InstallMedia,format=raw,if=none,file=BaseSystem.img \\    -device ide-hd,bus=sata.3,drive=InstallMedia \\    -drive id=SystemDisk,if=none,file=MyDisk.qcow2 \\    -device ide-hd,bus=sata.4,drive=SystemDisk \\    -nographic -vnc :0 -k en-us\n\n开机启动\n创建服务，创建文件/lib/systemd/system/macos.service\n\n[Unit]Description=macos[Service]Type=simpleExecStart=/usr/bin/sh /root/macos.shUser=root[Install]WantedBy=multi-user.target\n\n\n开机启动\n\nsystemctl enable macos\n\n参考文献\nmacOS-Simple-KVM\nqemu-networking\n\n","categories":["软路由"],"tags":["esxi","kvm"]},{"title":"PVE-RouterOS系统搭建与配置","url":"/pages/bdd8b581/","content":"环境\nProxmox 7\nRouterOS 6\n\nPVE安装RouterOS新建虚拟机常规-&gt;名称-&gt;RouterOS操作系统-&gt;客户机操作类型-&gt;类别-&gt;Linux操作系统-&gt;客户机操作类型-&gt;版本-&gt;5.x-2.6 kernel操作系统-&gt;不适用任何介质系统-&gt;无需修改系统-&gt;机型-&gt;q35磁盘-&gt;删除所有磁盘CPU-&gt;核心-&gt;4CPU-&gt;类别-&gt;hostCPU-&gt;CPU权重-&gt;2048内存-&gt;内存-&gt;2048网络-&gt;模型-&gt;VirtIO(半虚拟化)网络-&gt;防火墙-&gt;关\n\n下载和导入磁盘\n下载RouterOS云镜像的img镜像，并上传到PVE\n导入磁盘到虚拟机\n\n// 104为虚拟机idqm importdisk 104 /var/lib/vz/template/iso/routeros.img local-lvm\n\n\n虚拟机-&gt;硬件-&gt;双击磁盘添加\n虚拟机-&gt;选项-&gt;引导顺序-&gt;选中硬盘\n添加其他pcie设备,并选中PCI-Express\n启动虚拟机\n\n\n\nRouterOS配置配置网络\n配置一个静态ip，登录web\n\nip address add address=192.168.3.180 interface=ether1\n\n\n配置Interfaces\n\nInterfaces-&gt;Interface List-&gt;List-Add New-&gt;Namn-&gt;LAN/WANBridge-&gt;Bridge-&gt;Add New-&gt;Name-bridgeBridge-&gt;Ports-&gt;Add New-&gt;Interface-&gt;LANIP-&gt;DHCP-&gt;DHCP Setup\n\n导入默认防火墙配置\n\n#/ip firewall filteradd action=accept chain=input comment=&quot;defconf: accept established,related,untracked&quot; connection-state=established,related,untrackedadd action=drop chain=input comment=&quot;defconf: drop invalid&quot; connection-state=invalidadd action=accept chain=input comment=&quot;defconf: accept ICMP&quot; protocol=icmpadd action=accept chain=input comment=&quot;defconf: accept to local loopback (for CAPsMAN)&quot; dst-address=127.0.0.1add action=drop chain=input comment=&quot;defconf: drop all not coming from LAN&quot; in-interface-list=!LANadd action=accept chain=forward comment=&quot;defconf: accept in ipsec policy&quot; ipsec-policy=in,ipsecadd action=accept chain=forward comment=&quot;defconf: accept out ipsec policy&quot; ipsec-policy=out,ipsecadd action=fasttrack-connection chain=forward comment=&quot;defconf: fasttrack&quot; connection-state=established,relatedadd action=accept chain=forward comment=&quot;defconf: accept established,related, untracked&quot; connection-state=established,related,untrackedadd action=drop chain=forward comment=&quot;defconf: drop invalid&quot; connection-state=invalidadd action=drop chain=forward comment=&quot;defconf: drop all from WAN not DSTNATed&quot; connection-nat-state=!dstnat connection-state=new in-interface-list=WAN#/ip firewall natadd action=masquerade chain=srcnat comment=&quot;defconf: masquerade&quot; ipsec-policy=out,none out-interface-list=WAN#\n\n配置路由\n生成路由表(openwrt上运行)\n\n/usr/bin/curl &#x27;http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest&#x27; | grep ipv4 | grep CN | awk -F\\| &#x27;&#123; printf(&quot;%s/%d\\n&quot;, $4, 32-log($5)/log(2)) &#125;&#x27; |sed -e &#x27;s/^/add address=/g&#x27; -e &#x27;s/$/ list=CNIP/g&#x27;|sed -e $&#x27;1i\\\\\\n/ip firewall address-list&#x27; -e $&#x27;1i\\\\\\nremove [/ip firewall address-list find list=CNIP]&#x27; -e $&#x27;1i\\\\\\nadd address=10.0.0.0/8 list=CNIP comment=private-network&#x27; -e $&#x27;1i\\\\\\nadd address=172.16.0.0/12 list=CNIP comment=private-network&#x27; -e $&#x27;1i\\\\\\nadd address=192.168.0.0/16 list=CNIP comment=private-network&#x27;&gt;/www/cnip.rsc\n\n\n手动RouterOS导入地址\n\n/im file=cnip.rsc\n\n\nRouterOS自动导入地址\n\n\n新建脚本(System-&gt;Scripts-&gt;Scripts-&gt;add New)\n\n# Update blocked.rsc/tool fetch mode=http url=&quot;http://192.168.3.2/cnip.rsc&quot; dst-path=cnip.rsc/im file=cnip.rsc\n\n新建定时器(System-&gt;Scheduler-&gt;Add New)\n\n:execute script=&quot;cnip&quot;\n\n\n设置路由\n\nIP-&gt;Routers-&gt;Add New-&gt;Address(0.0.0.0/0)/Gateway(192.168.3.2)/Routing Make(world)IP-&gt;Firewall-&gt;Mangle-&gt;-&gt;Add New-&gt;China(prerouting)/Src.Address(192.168.3.2)/Action(accept)IP-&gt;Firewall-&gt;Mangle-&gt;-&gt;Add New-&gt;Chain(prerouting)/Dst.Address List(!CNIP)/Action(make routing)/New Routing Mark(world)/enable Passthrough\n\n5.配置dns\nIP-&gt;DNS\n\n参考\nrouteros配置vpn分流大陆ip\n主路ROS+旁路OP 流量分流+DNS分流 最佳方案教程\n\n","categories":["软路由"],"tags":["PVE","RouterOS"]},{"title":"PVE-LXC-Openwrt系统搭建与配置","url":"/pages/716d62c5/","content":"环境\nProxmox 7\nOpenwrt 21.02.3\n\nPVE安装Openwrt开启udp转发echo &#x27;xt_TPROXY&#x27; &gt; /etc/modules-load.d/tproxy.conf\n\n新建LXCpct create 101 \\\tlocal:vztmpl/openwrt-21.02.3-x86-64-rootfs.tar.gz \\\t--rootfs local-lvm:2 \\\t--ostype unmanaged \\\t--hostname OpenWrt \\\t--arch amd64 \\\t--cores 4 \\\t--memory 2048 \\\t--swap 0 \n\n修改配置文件 /etc/pve/lxc/101.confarch: amd64cores: 4hookscript: local:snippets/openwrt.plhostname: OpenWrtmemory: 2048ostype: unmanagedrootfs: local:101/vm-101-disk-0.raw,size=2Gswap: 0lxc.include: /usr/share/lxc/config/openwrt.common.conf# /dev/ppp  pppoe拨号等功能需要用到lxc.cgroup.devices.allow: c 108:0 rwmlxc.net.0.type: phys# 网卡名称lxc.net.0.link: enp11s0f0lxc.net.0.flags: uplxc.net.0.name: eth0\n创建钩子脚本//复制cp /usr/share/pve-docs/examples/guest-example-hookscript.pl /var/lib/vz/snippets/openwrt.pl//修改内容# Second phase &#x27;post-start&#x27; will be executed after the guest# successfully started.system(&quot;lxc-device add -n $vmid /dev/ppp&quot;);system(&quot;lxc-device add -n $vmid /dev/net/tun&quot;);print &quot;$vmid started successfully.\\n&quot;;\n\n\n常用分享常用源src/gz openwrt_dist http://openwrt-dist.sourceforge.net/packages/base/x86_64src/gz openwrt_dist_luci http://openwrt-dist.sourceforge.net/packages/luci\n\n常用软件shadowsocks-libev   ChinaDNS python3  luci-app-chinadns dns-forwarder luci-i18n-wireguard-zh-cn iptables-mod-tproxy  luci-app-dns-forwarder  luci-i18n-base-zh-cn luci-i18n-opkg-zh-cn luci-app-shadowsocks luci-i18n-firewall-zh-cn luci-compat \n\n常用脚本\n软件更新\n\nopkg updateopkg list-upgradable | cut -f 1 -d &#x27; &#x27; | xargs opkg upgrade\n\n\n更新chinadns\n\n/usr/bin/wget -O- &#x27;http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest&#x27; | awk -F\\| &#x27;/CN\\|ipv4/ &#123; printf(&quot;%s/%d\\n&quot;, $4, 32-log($5)/log(2)) &#125;&#x27; &gt; /etc/chinadns_chnroute.txt\n\n\n更新RouterOS的cnip文件\n\n/usr/bin/curl &#x27;http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest&#x27; | grep ipv4 | grep CN | awk -F\\| &#x27;&#123; printf(&quot;%s/%d\\n&quot;, $4, 32-log($5)/log(2)) &#125;&#x27; |sed -e &#x27;s/^/add address=/g&#x27; -e &#x27;s/$/ list=CNIP/g&#x27;|sed -e $&#x27;1i\\\\\\n/ip firewall address-list&#x27; -e $&#x27;1i\\\\\\nremove [/ip firewall address-list find list=CNIP]&#x27; -e $&#x27;1i\\\\\\nadd address=10.0.0.0/8 list=CNIP comment=private-network&#x27; -e $&#x27;1i\\\\\\nadd address=172.16.0.0/12 list=CNIP comment=private-network&#x27; -e $&#x27;1i\\\\\\nadd address=192.168.0.0/16 list=CNIP comment=private-network&#x27;&gt;/www/cnip.rsc\n\n\n更新自动代理pac文件\n\n/usr/bin/genpac --proxy=&quot;SOCKS5 192.168.3.2:1080&quot; --gfwlist-proxy=&quot;SOCKS5 192.168.3.2:1080&quot; -o /www/gfwlist.pac\n\n\n更新iptv播放列表\n\ncurl https://raw.githubusercontent.com/iptv-org/iptv/master/streams/cn.m3u -o /www/cn.m3u\n\n\n安装的软件包\n\nawk &#x27;/^Package:/&#123;PKG= $2&#125; /^Status: .*user installed/&#123;print PKG&#125;&#x27; /usr/lib/opkg/status\n\n参考\nopenwrt下载地址\n\n","categories":["软路由"],"tags":["Openwrt"]},{"title":"nftables端口转发","url":"/pages/f4ac01ca/","content":"环境\ndebian 11\n\n配置编辑/etc/sysctl.conf\n允许端口转发\n\n#文件末尾添加net.ipv4.ip_forward=1\n\n创建文件/etc/nftables/example.nft\n配置文件必须在/etc/nftables/目录下\n\n#!/usr/sbin/nft -fdefine localIP = 本地ipdefine remoteIP = 远程ipdefine remotePort = 端口(80)/端口范围(80-89)define localPort = 端口(80)/端口范围(80-89)# Flush the rule set#flush rulesetadd table ip natadd chain nat PREROUTING &#123; type nat hook prerouting priority -100 ; &#125;add chain nat POSTROUTING &#123; type nat hook postrouting priority 100 ; &#125;add rule ip nat PREROUTING tcp dport $localPort counter dnat to $remoteIP:$remotePortadd rule ip nat PREROUTING udp dport $localPort counter dnat to $remoteIP:$remotePortadd rule ip nat POSTROUTING ip daddr $remoteIP tcp dport $remotePort counter snat to $localIPadd rule ip nat POSTROUTING ip daddr $remoteIP udp dport $remotePort counter snat to $localIP\n\n编辑/etc/nftables.conf\n加载自定义配置文件\n\n//默认配置内容#!/usr/sbin/nft -fflush rulesettable inet filter &#123;        chain input &#123;                type filter hook input priority 0;        &#125;        chain forward &#123;                type filter hook forward priority 0;        &#125;        chain output &#123;                type filter hook output priority 0;        &#125;&#125;#文件末尾添加include &quot;/etc/nftables/tranfrom.nft&quot;\n\n\n设置开机启动//开机启动systemctl enable nftables.service//马上启动systemctl start nftables.service//查看状态systemctl status nftables.service\n\n参考文献\nnftables设置nat转发(基于centos8)\nRedHat帮助文档\n\n","categories":["软路由"],"tags":["nftables","vps"]},{"title":"PVE-HomeAssistant安装配置","url":"/pages/b33c9199/","content":"环境\nProxmox 7\nHomeAssistant 8\n\n配置IOMMU分组#编辑 /etc/default/grub#AMD用户修改为GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet amd_iommu=on pcie_acs_override=downstream,multifunction&quot;update-grub#编辑 /etc/modules#修改为vfiovfio_iommu_type1vfio_pcivfio_virqfd#最后重启reboot \n\nPVE安装创建虚拟机配置系统-&gt;BIOS-&gt;OVMF(UEFI)\n\n导入磁盘文件qm importdisk 102 haos_generic-x86-64-8.0.rc3.img local\n\n使用磁盘双击磁盘-&gt;sata选项-&gt;启动引导-&gt;sata0\n\n修改配置文件 /etc/pve/qemu-server/102.conf bios: ovmfboot: order=sata0cores: 2cpu: hosthostpci0: 0000:0b:00.1,pcie=1machine: q35memory: 2048meta: creation-qemu=6.1.1,ctime=1651069024name: Hassionuma: 0ostype: l26sata0: local:102/vm-102-disk-0.raw,size=6G,ssd=1scsihw: virtio-scsi-pcismbios1: uuid=02be9043-b8f6-42f7-a94e-05817fd4b2ffsockets: 1vmgenid: c6bf3dcd-dec9-4a6a-bb8d-69726f3fe659\n\n参考\nHomeAssistant下载\n\n","categories":["软路由"],"tags":["HomeAssistant"]},{"title":"PVE-LXC-Plex服务安装","url":"/pages/c5ec55f0/","content":"环境\nProxmox 7\nPlex Server\n\nPVE安装创建CT配置 /etc/pve/lxc/103.conf arch: amd64cores: 4hostname: Plexmemory: 4096ostype: debianrootfs: local:103/vm-103-disk-0.raw,size=4Gswap: 0lxc.net.0.type: physlxc.net.0.link: enp12s0f0lxc.net.0.flags: uplxc.net.0.name: eth0\n\n配置系统设置静态ip /etc/network/interfacesauto loiface lo inet loopbackauto eth0iface eth0 inet staticaddress 192.168.3.4netmask 255.255.255.0gateway 192.168.3.1\n\n安装依赖apt install gnupg gnupg2 gnupg1 curl\n\n安装Plexecho deb https://downloads.plex.tv/repo/deb public main | tee /etc/apt/sources.list.d/plexmediaserver.listcurl https://downloads.plex.tv/plex-keys/PlexSign.key | apt-key add -apt install plexmediaserver\n\n\n\n\n","categories":["软路由"],"tags":["Plex"]},{"title":"PVE-黑群晖安装","url":"/pages/bf5e1c36/","content":"环境\nProxmox 7\ndsm7.1\n\n编译引导文件注册github，fork项目https://github.com/tossp/redpill-tool-chain\n\n修改配置\n获取SataPortMap和DiskIdxMap\n\n# 下载地址# https://github.com/pocopico/tinycore-redpill# 获取./rploader.sh satamap now\n\n\nsample_user_config.json\n\n# &quot;DiskIdxMap&quot;: &quot;0100&quot;,第一个sata控制器的磁盘编号01，02，03，04，第二个sata控制器的磁盘编号00# &quot;SataPortMap&quot;: &quot;41&quot;,两个sata控制器，分别可以叉4个硬盘和1个硬盘&#123;    &quot;extra_cmdline&quot;: &#123;        &quot;pid&quot;: &quot;0x0001&quot;,        &quot;vid&quot;: &quot;0x46f4&quot;,        &quot;DiskIdxMap&quot;: &quot;0100&quot;,        &quot;SataPortMap&quot;: &quot;41&quot;,        &quot;SasIdxMap&quot;: &quot;0&quot;,        &quot;sn&quot;: &quot;1234XXX123&quot;,        &quot;mac1&quot;: &quot;XXYYXXYYXXYY&quot;    &#125;,    &quot;synoinfo&quot;: &#123;&#125;,    &quot;ramdisk_copy&quot;: &#123;&#125;,    &quot;extensions&quot;: []&#125;\n\n添加驱动\n驱动仓库\n\nhttps://github.com/pocopico/rp-ext\n\n\n修改文件添加驱动 .github/workflows/text.yml\n个人测试bnx2驱动不生效，建议直接使用intel网卡\n\n\n\n- name: 添加扩展驱动        if: matrix.platform != &#x27;dva3221&#x27;        run: |          ./redpill_tool_chain.sh add https://github.com/tossp/redpill-tool-chain/raw/master/extensions/redpill-boot-wait.json          ./redpill_tool_chain.sh add https://github.com/tossp/redpill-tool-chain/raw/master/extensions/redpill-acpid.json          ./redpill_tool_chain.sh add https://github.com/tossp/redpill-tool-chain/raw/master/extensions/redpill-virtio.json                    # 新增内容          ./redpill_tool_chain.sh add https://raw.githubusercontent.com/pocopico/rp-ext/master/bnx2/rpext-index.json          ./redpill_tool_chain.sh add https://raw.githubusercontent.com/pocopico/rp-ext/master/igb/rpext-index.json\n\n提交代码，github仓库执行actions编译，然后下载PVE虚拟机虚拟机配置\n/etc/pve/qemu-server/104.conf\n\nbios: ovmfboot: order=sata0cores: 4cpu: hosthostpci0: 0000:08:00.0hostpci1: 0000:03:00.1,pcie=1machine: q35memory: 8192meta: creation-qemu=6.1.1,ctime=1651237325name: NASnuma: 0ostype: l26sata0: local:104/vm-104-disk-0.raw,size=160Msmbios1: uuid=26cff932-b709-4ffc-a292-92d20b03cfd7sockets: 1vmgenid: 3b99a19a-7d2a-4551-993b-1e80fa6783be\n\n安装群晖系统\n下载地址\n\nhttps://archive.synology.cn/download/Os/DSM\n\n参考\nredpill-tool-chain\ntinycore-redpill\nrp-ext\n获取SataPortMap和DiskIdxMap\n\n","categories":["软路由"],"tags":["黑群晖"]},{"title":"PVE-OSX-KVM黑苹果","url":"/pages/ad20e89e/","content":"环境\nProxmox 7\n\n制作引导文件下载库git clone https://github.com/kholia/OSX-KVM.git\n\n下载并转换 OSX-KVM#下载./fetch-macOS-v2.py#转换qemu-img convert BaseSystem.dmg -O raw BaseSystem.img#迁移mv BaseSystem.img /var/lib/vz/template/iso/\n\n提取opencore /OSX-KVM/OpenCore#解压7z x OpenCore.qcow2#迁移mv primary.img /var/lib/vz/template/iso/\n\n设置虚拟机(Intel)args: -device isa-applesmc,osk=&quot;ourhardworkbythesewordsguardedpleasedontsteal(c)AppleComputerInc&quot; -smbios type=2 -device usb-kbd,bus=ehci.0,port=2 -cpu host,kvm=on,vendor=GenuineIntel,+kvm_pv_unhalt,+kvm_pv_eoi,+hypervisor,+invtscbios: ovmfboot: order=sata0;ide2;net0;ide0cores: 4cpu: hostefidisk0: local:100/vm-100-disk-0.raw,efitype=4m,size=528Kide0: local:iso/BaseSystem.img,cache=unsafe,size=3143856Kide2: local:iso/primary.img,cache=unsafe,size=152551936machine: q35memory: 10240meta: creation-qemu=6.2.0,ctime=1653753564name: macOSnet0: virtio=D2:80:05:5C:93:06,bridge=vmbr0,firewall=1numa: 0ostype: othersata0: local:100/vm-100-disk-1.qcow2,cache=unsafe,size=200G,ssd=1scsihw: virtio-scsi-pcismbios1: uuid=4cdfd0e3-e10a-4856-b498-99bb89e4fa7csockets: 1vga: vmwarevmgenid: 0d9974ea-5ae4-416f-8486-484b5e4a52a0\n\n参考OSX-KVMInstalling macOS 12 “Monterey” on Proxmox 7Proxmox VE 7.1安装macOS 10.15及GPU穿通方案\n","categories":["软路由"],"tags":["黑苹果"]},{"title":"树莓派 ALL in ONE","url":"/pages/9d07025b/","content":"更新\n本文已经停止维护，请跳转最新地址\n\nMaktub_Wiki&#x2F;服务搭建\n环境\nRaspberry Pi OS Lite\n\n配置开机自启动\nauto.sh文件\n\n#开启混杂模式ip link set eth0 promisc on#docker macvlan互通ip link add macvlan_br link eth0 type macvlan mode bridgeip addr add 192.168.3.5 dev macvlan_brip link set macvlan_br upip link set macvlan_br promisc onip route add 192.168.3.9 dev macvlan_br#zerotier转发iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADEiptables -A FORWARD -i eth0 -o ztr2qvners -m state --state RELATED,ESTABLISHED -j ACCEPTiptables -A FORWARD -i ztr2qvners -o eth0 -j ACCEPTiptables -t nat -A POSTROUTING -o macvlan_br -j MASQUERADEiptables -A FORWARD -i macvlan_br -o ztr2qvners -m state --state RELATED,ESTABLISHED -j ACCEPTiptables -A FORWARD -i ztr2qvners -o macvlan_br -j ACCEPT\n\n\n编辑 /etc/rc.local\n\n#!/bin/sh -e## rc.local## This script is executed at the end of each multiuser runlevel.# Make sure that the script will &quot;exit 0&quot; on success or any other# value on error.## In order to enable or disable this script just change the execution# bits.## By default this script does nothing.# Print the IP address_IP=$(hostname -I) || trueif [ &quot;$_IP&quot; ]; then  printf &quot;My IP address is %s\\n&quot; &quot;$_IP&quot;fi#挂载硬盘mount -t ext4 /dev/sda1 /mnt/disk# 延迟启动(sleep 30/bin/bash /root/.auto/auto.sh) &amp;exit 0\n\n\n解决树莓派断开网络连接后，路由消失,为树莓派添加静态路由编辑文件/lib/dhcpcd/dhcpcd-hooks/40-route\n\nip route add 192.168.3.9 dev macvlan_br\n\ndocker管理工具https://github.com/jesseduffield/lazydocker#快捷命令alias lazydocker=&#x27;/root/.tool/lazydocker&#x27;\n\nwireguard管理工具https://github.com/ngoduykhanh/wireguard-ui\n\nflare标签页管理docker run -d --name flare --restart=always  -p 5005:5005 -v /mnt/disk/docker/flare:/app soulteary/flare\n\nzerotier异地组网docker run -d --name zerotier --restart=always --device=/dev/net/tun --net=host --cap-add=NET_ADMIN --cap-add=SYS_ADMIN -v /mnt/disk/docker/zerotier-one:/var/lib/zerotier-one  -v /etc/gai.conf:/etc/gai.conf zerotier/zerotier:latest# 开启转发cho &quot;net.ipv4.ip_forward = 1&quot; &gt;&gt; /etc/sysctl.conf sysctl -p# 配置防火墙ip link set eth0 promisc oniptables -t nat -A POSTROUTING -o eth0 -j MASQUERADEiptables -A FORWARD -i eth0 -o ztr2qvners -m state --state RELATED,ESTABLISHED -j ACCEPTiptables -A FORWARD -i ztr2qvners -o eth0 -j ACCEPT\n\nplex影音库version: &quot;3&quot;services:  plex:    image: plexinc/pms-docker    restart: always    network_mode: host    hostname: moviepilot        volumes:         - ./config:/config      - ./transcode:/transcode      - /mnt/down/download/Plex:/data    environment:       - UMASK=000\n\nmusic_tag_web音乐信息修改docker run -d --name music_tag  -p 8001:8001 -v /mnt/down/Plex/Music:/app/media -v /mnt/disk/docker/music_tag_web:/app/data --restart=always xhongc/music_tag_web:latest\n\nfilebrowser文件管理docker run -d --name filebrowser --restart=always  -v /mnt:/srv  -v /mnt/disk/docker/filebrowser/filebrowser.db:/database.db  -u $(id -u):$(id -g)  -p 8082:80  filebrowser/filebrowser\n迅雷离线下载工具\n邀请码 我不是矿神IMNKS\n\ndocker run -d --name=xunlei --hostname=mynas --net=host -v /mnt/disk/docker/xunlei:/xunlei/data -v /mnt/down/xunleidownloads:/xunlei/downloads --restart=unless-stopped --privileged cnk3x/xunlei:latest\nqbittorrent 下载工具docker run -d  --name=qbittorrent --network=host  -e PUID=1000  -e PGID=1000   -e WEBUI_PORT=8081 -v /mnt/disk/docker/qbittorrent/config:/config  -v /mnt/disk/download:/downloads  --restart unless-stopped linuxserver/qbittorrent\n\nhome-assistants智能家居中心docker run -d --name home-assistants --restart=always -v /mnt/disk/docker/hassio:/config --network=host homeassistant/home-assistant\nsmb共享vim  /etc/samba/smb.conf[smb]path = /mnt/diskwriteable=Yescreate mask=0777directory mask=0777public=yesbrowseable=yesvalid users = rootguest ok = no\n\nalist 网盘挂载docker run -d --restart=always -v /mnt/disk/docker/alist:/opt/alist/data -v /mnt/down/alistdown/:/download  -p 5244:5244 --name=&quot;alist&quot; xhofe/alist:latest\n\nmoviepilot 媒体搜索version: &quot;3&quot;services:  moviepilot:    image: jxxghp/moviepilot:latest    ports:        - 3000:3000 # web 接口    restart: always    network_mode: bridge    hostname: moviepilot        volumes:         - ./moviepilot:/moviepilot #程序主目录，必选      - ./config:/config #config 配置文件，必选      - /mnt/down/download:/downloads    environment: # 基础设置      - UMASK=000      - SUPERUSER=xxxxxx   #登录账号      - TMDB_API_DOMAIN=api.tmdb.org# 下载目录设置      - DOWNLOAD_PATH=/downloads/moviepilot   # 下载保存目录      - DOWNLOAD_MOVIE_PATH=/downloads/moviepilot/Movie      - DOWNLOAD_TV_PATH=/downloads/moviepilot/TVShow      - DOWNLOAD_ANIME_PATH=/downloads/moviepilot/Anime      - DOWNLOAD_CATEGORY=false #下载二级分类开关# 媒体库功能设置           - TRANSFER_TYPE=link      #转移方式，支持link/copy/move/softlink        - LIBRARY_PATH=/downloads/Plex      - LIBRARY_MOVIE_NAME=Movie      - LIBRARY_TV_NAME=TVShow      - LIBRARY_ANIME_NAME=Anime      - LIBRARY_CATEGORY=false      - SCRAP_METADATA=false# 下载器设置     ##qbittorrent设置项      - DOWNLOADER=qbittorrent      - QB_HOST=http://xxxxxx:xxxxx # qbittorrent地址      - QB_USER=xxxxxxx      - QB_PASSWORD=xxxxxxx# 媒体服务器      - MEDIASERVER=plex         - PLEX_HOST=http://xxxx:xxxxx      - PLEX_TOKEN=xxxxxxxx      - MEDIASERVER_SYNC_BLACKLIST:音乐            - BIG_MEMORY_MODE=true# 用户认证      - AUTH_SITE=wintersakura  #认证站点      - WINTERSAKURA_UID=xxxxxxx # 观众 ID       - WINTERSAKURA_PASSKEY=xxxxxxxx # 观众 passkey      - COOKIECLOUD_INTERVAL=10000000\n\ncalibre-web 图书管理docker run -d \\  --name=calibre-web \\  -e PUID=0 \\  -e PGID=0 \\  -e TZ=Asia/Chongqing \\  -p 8083:8083 \\  -v /mnt/disk/docker/calibre/config:/config \\  -v /mnt/disk/docker/calibre/books:/books \\  --restart unless-stopped \\  linuxserver/calibre-web:latest\n\n\n已经废弃，不使用nas-tools 媒体搜索docker run -d --name nas-tools --restart=always --hostname nas-tools -p 3000:3000 -v /mnt/disk/docker/nastools/config:/config --network host  -v /mnt/down:/disk  -e PUID=1000 -e PGID=1000 -e UMASK=000 -e NASTOOL_AUTO_UPDATE=false nastool/nas-tools\n\nopenwrt\n创建虚拟网络\n\nip link set eth0 promisc ondocker network create -d macvlan --subnet=192.168.3.1/24 --gateway=192.168.3.8 -o parent=eth0 macnet\n\n配置防火墙\n\nip link set eth0 promisc on# docker valueip link add link eth0 brnet type macvlan mode bridgeip link set dev brnet up//192.168.3.9 容器ipip route add 192.168.3.9 dev brnet\n\n导入镜像\n\ndocker import https://downloads.openwrt.org/releases/22.03.2/targets/armvirt/64/openwrt-22.03.2-armvirt-64-default-rootfs.tar.gz openwrt-22.03.2# 或docker pull openwrtorg/rootfs:armvirt-64-22.03.2\n\n\n创建容器\n\ndocker run --restart always --name openwrt -d --network macnet --privileged openwrtorg/rootfs:armvirt-64-22.03.2 /sbin/init\n\nV2rayA透明代理docker run -d --restart=always --cpu-shares 3072 --privileged --network=macnet --ip 192.168.3.9 --name v2raya -e V2RAYA_LOG_FILE=/tmp/v2raya.log -v /lib/modules:/lib/modules:ro -v /etc/resolv.conf:/etc/resolv.conf -v /mnt/disk/docker/v2raya/config:/etc/v2raya mzz2017/v2raya\n\nclash透明代理\n安装\n\ndocker run -d  --name clash  --restart unless-stopped --device=/dev/net/tun --log-opt max-size=1m  --network host --privileged  -v /mnt/disk/docker/clash:/root/.config/clash  dreamacro/clash-premium\n\n\n配置文件\n\nmixed-port: 7890socks-port: 7891redir-port: 7892# Transparent proxy server port for Linux (TProxy TCP and TProxy UDP)tproxy-port: 7893allow-lan: truemode: Rulelog-level: info #info #debugexternal-ui: clash-dashboardexternal-controller: 0.0.0.0:9090secret: &quot;&quot;experimental:  ignore-resolve-fail: true # ignore dns reslove fail, default value is truedns:  enable: true  listen: 0.0.0.0:53  ipv6: false  enhanced-mode: redir-host #redir-host #fake-ip  fake-ip-range: 198.18.0.1/16  fake-ip-filter: # fake ip white domain list    - &#x27;*.lan&#x27;  nameserver:    - 114.114.114.114    - 8.8.8.8  fallback:    - 114.114.114.114    - 8.8.8.8interface-name: eth0auto-redir:  enable: true  auto-route: truetun:  enable: true  stack: system  dns-hijack:    - any:53    - tcp://any:53  auto-route: true#ebpf和zerotier和wirguard冲突#ebpf:    #redirect-to-tun:        #- eth0#直连端口rules:  - DST-PORT,9993,DIRECT  - SRC-PORT,9993,DIRECT  - DST-PORT,18721,DIRECT  - SRC-PORT,18721,DIRECT\n\n","categories":["软路由"],"tags":["树莓派"]},{"title":"拯救被墙ip-vmess+ws+tls套cf+cdn","url":"/pages/1e41147d/","content":"一键安装脚本\nV2Ray_ws-tls_bash_onekey\n\n注册cloudflare\n域名配置dns\n控制面板DNS配置域名A解析\n控制面板SSL/TLS设置为Full(strict)\n\n免费域名注册\nFreenom\n\n遇到的问题\nGit: Failed sending HTTP2 data solution\n\nsudo apt reinstall libcurl3-gnutls/buster\n\n","categories":["VPS"],"tags":["VPS"]},{"title":"32M内存ipv6运行v2ray套cf cdn","url":"/pages/78e7ed04/","content":"环境\nalpine 3.16\n\nV2ray\n安装\n\n#安装apk add v2ray#开机启动rc-update add v2ray#启动rc-service v2ray\n\n\n配置/etc/v2ray/config.json\n\n&#123;  &quot;inbounds&quot;: [    &#123;      &quot;port&quot;: 80,      &quot;listen&quot;:&quot;::&quot;,      &quot;protocol&quot;: &quot;vmess&quot;,      &quot;settings&quot;: &#123;        &quot;clients&quot;: [          &#123;            &quot;id&quot;: &quot;#自己生成uuid&quot;,            &quot;alterId&quot;: 0          &#125;        ]      &#125;,      &quot;streamSettings&quot;: &#123;        &quot;network&quot;: &quot;ws&quot;,        &quot;wsSettings&quot;: &#123;        &quot;path&quot;: &quot;#自己填写路径&quot;        &#125;      &#125;    &#125;  ],  &quot;outbounds&quot;: [    &#123;      &quot;protocol&quot;: &quot;freedom&quot;,      &quot;settings&quot;: &#123;&#125;    &#125;  ]&#125;\n\nCloudflare配置\n首页-&gt;Workers-&gt;Create a Service\n选择Http handler和Service Worker Syntax\n右上角Quick edit\n\naddEventListener(  &#x27;fetch&#x27;,event =&gt; &#123;     let url=new URL(event.request.url);     url.hostname=&#x27;#自己的域名,如xxx.baidu.com&#x27;;     if(url.protocol == &#x27;https:&#x27;) &#123;        url.protocol=&#x27;http:&#x27;     &#125;     let request=new Request(url,event.request);     if(request.headers.has(&quot;Origin&quot;)) &#123;       request.headers.delete(&quot;Origin&quot;);     &#125;     event.respondWith(          fetch(request)    )  &#125;)\n\n域名管理页面Workers Routes\nRoute填写域名，如xxx.baidu.com/*\nService选择你创建的Workers Service\n\n参考\nv2ray套CF无域名加速的小白教程\n\n","categories":["VPS"],"tags":["VPS"]},{"title":"手动搭建vmess+ws+tls(V2ray+Caddy)","url":"/pages/d20bb833/","content":"V2Ray\n安装\n\nbash &lt;(curl -L https://raw.githubusercontent.com/v2fly/fhs-install-v2ray/master/install-release.sh)\n\n\n配置/usr/local/etc/v2ray/config.json\n\n&#123;  &quot;inbounds&quot;: [    &#123;      &quot;port&quot;: 10000,      &quot;listen&quot;:&quot;127.0.0.1&quot;,      &quot;protocol&quot;: &quot;vmess&quot;,      &quot;settings&quot;: &#123;        &quot;clients&quot;: [          &#123;            &quot;id&quot;: &quot;#自己生成uuid&quot;,            &quot;alterId&quot;: 0          &#125;        ]      &#125;,      &quot;streamSettings&quot;: &#123;        &quot;network&quot;: &quot;ws&quot;,        &quot;wsSettings&quot;: &#123;        &quot;path&quot;: &quot;#自己填写路径&quot;        &#125;      &#125;    &#125;  ],  &quot;outbounds&quot;: [    &#123;      &quot;protocol&quot;: &quot;freedom&quot;,      &quot;settings&quot;: &#123;&#125;    &#125;  ]&#125;\n\nCaddy\n注意：启动申请证书没成功前不要开启CDN\n\n\n安装\n\napt install -y debian-keyring debian-archive-keyring apt-transport-httpscurl -1sLf &#x27;https://dl.cloudsmith.io/public/caddy/stable/gpg.key&#x27; | gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpgcurl -1sLf &#x27;https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt&#x27; | tee /etc/apt/sources.list.d/caddy-stable.listapt updateapt install caddy\n\n\n配置/etc/caddy/Caddyfile\n\n#域名 &#123;  log &#123;      output file /etc/caddy/caddy.log  &#125;  tls &#123;      protocols tls1.2 tls1.3      ciphers TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384 TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256      curves x25519  &#125;  @v2ray_websocket &#123;      path v2ray的路径      header Connection Upgrade      header Upgrade websocket  &#125;  reverse_proxy @v2ray_websocket localhost:10000&#125;\n\n校验\n\nwget https://#域名\n\n参考资料\nWebSocket + TLS + Web\nfhs-install-v2ray\n\n","categories":["VPS"],"tags":["VPS"]},{"title":"Scascaleway 自动开机脚本","url":"/pages/4209dbe0/","content":"环境\nMACOS\n\n安装brew install scw\n\n创建虚拟机# 登录scw init# 创建服务器scw instance server create type=STARDUST1-S zone=fr-par-1 image=debian_bullseye root-volume=l:10G name=Denian ip=none ipv6=true project-id=你的账号UUID# 查看服务器scw instance server list# 开机scw instance server start 你的机器UUID\n\n开机脚本#!/bin/zshMACHINE_UUID=&quot;你的机器UUID&quot;STAR_MACHINE() &#123;    scw instance server start &quot;$&#123;MACHINE_UUID&#125;&quot;&#125;SEND_NOTIFY()&#123;\techo &quot;成功&quot;\t&#125;while true; do\tSTATUS=$(scw instance server list | sed -n &#x27;2p&#x27; | awk &#x27;&#123;print $4&#125;&#x27;)\tif [[ $&#123;STATUS&#125; == &quot;starting&quot; ]]; then\t\techo &quot;Your server status is $&#123;STATUS&#125;&quot;\t\techo &quot;Starting...Wait for 60 seconds to check again...&quot;\t\tsleep 60\telif [[ $&#123;STATUS&#125; == &quot;archived&quot; ]]; then\t\techo &quot;Your server status is $&#123;STATUS&#125;&quot;\t\techo &quot;Now we start your machine...&quot;\t\tSTAR_MACHINE\t\tsleep 60\telse\t\tSEND_NOTIFY\t\tbreak\tfidone\n\n参考\n星尘Scaleway IPv6 VPS API 自动开机脚本\nscaleway-cli\n\n","categories":["VPS"],"tags":["VPS"]},{"title":"shell命令行管理vps","url":"/pages/57a9596a/","content":"脚本 sshmgr.sh#!/bin/bashconf=/Users/h/Tool/sshmgr.confset sshname=set sshhost=menu() &#123;    while read line    do        if [ &quot;$&#123;line:0:1&#125;&quot; == &quot;#&quot; ];then            continue        fi        if [ &quot;$&#123;line&#125;z&quot; == &quot;z&quot; ];then            continue        fi        if [ &quot;$&#123;line:0:2&#125;&quot; == &quot;--&quot; ];then            echo &#x27;&#x27;            continue        fi        # # 序号 | 显示名称 | IP | 端口 | 用户名 | 密码 | key         id=`echo $line|awk -F &quot;|&quot; &#x27;&#123;print $1&#125;&#x27;`        name=`echo $line|awk -F &quot;|&quot; &#x27;&#123;print $2&#125;&#x27;`        ip=`echo $line|awk -F &quot;|&quot; &#x27;&#123;print $3&#125;&#x27;`        echo $id $name $ip    done &lt; $&#123;conf&#125;&#125;link() &#123;    while read line    do        if [ &quot;$&#123;line:0:1&#125;&quot; == &quot;#&quot; ];then            continue        fi        if [ &quot;$&#123;line&#125;z&quot; == &quot;z&quot; ];then            continue        fi        if [ &quot;$&#123;line:0:2&#125;&quot; == &quot;--&quot; ];then            continue        fi        # # 序号 | 显示名称 | IP | 端口 | 用户名 | key         id=`echo $line|awk -F &quot;|&quot; &#x27;&#123;print $1&#125;&#x27;`        name=`echo $line|awk -F &quot;|&quot; &#x27;&#123;print $2&#125;&#x27;`        host=`echo $line|awk -F &quot;|&quot; &#x27;&#123;print $3&#125;&#x27;`        port=`echo $line|awk -F &quot;|&quot; &#x27;&#123;print $4&#125;&#x27;`        username=`echo $line|awk -F &quot;|&quot; &#x27;&#123;print $5&#125;&#x27;`        key=`echo $line|awk -F &quot;|&quot; &#x27;&#123;print $6&#125;&#x27;`        if [ &quot;$id&quot; -eq &quot;$1&quot; ];then            sshname=$name            sshhost=`echo $username@$host -p $port -i $key`            break        fi    done &lt; $&#123;conf&#125;&#125;while true; do  menu  read -p &#x27;输入进入的服务器:&#x27; cmd    if [ &quot;$&#123;cmd&#125;&quot; == &quot;0&quot; ];then    break  fi  sshhost=  link $cmd  if [ -z &quot;$&#123;sshhost&#125;&quot; ];then    echo &#x27;选择的服务器不存在,请重新选择.&#x27;  else    echo 正在链接[$name]服务器...    ssh $sshhost  fidone\n配置文件 sshmgr.conf# 序号 | 显示名称 | IP | 端口 | 用户名 | key 1|namea|192.168.1.1|22|root|~/.ssh/id_rsa\n\n快捷启动.zshrcalias ssmgr=&#x27;/Users/h/Tool/sshmgr.sh&#x27;\n\n参考\nMac中多ssh连接管理脚本\n\n","categories":["VPS"],"tags":["VPS"]},{"title":"纯ipv6 vps 套cf wrap拥有ipv4的访问能力","url":"/pages/435fe954/","content":"\n感谢Cloudflare的免费服务，大家合理使用\n\n安装wireguardapt install wireguard-tools\n\n安装wgfc# 安装 wgcfcurl -fsSL git.io/wgcf.sh | sudo bash# 注册wgcf register# 生成配置wgcf generate\n\n配置和启动\n修改配置文件\n\n[Interface]PrivateKey = MKAskClhM858SHhlrCHG0HRgWaEIhLslJYuxOV9Ct30=Address = 自动生成Address = 自动生成DNS = 2001:4860:4860::8888,2001:4860:4860::8844,8.8.8.8,8.8.4.4MTU = 1280#ipv4#PostUp = ip -4 rule add from 本地ipv4 lookup main#PostDown = ip -4 rule delete from 本地ipv4 lookup mainPostUp = ip -6 rule add from 本地ipv6 lookup mainPostDown = ip -6 rule delete from 本地ipv6 lookup main[Peer]PublicKey = bmXOC+F1FxEMF9dyiK2H5/1SUtzH0JuVo51h2wPfgyo=AllowedIPs = 0.0.0.0/0Endpoint = [2606:4700:d0::a29f:c001]:2408\n\n启动指令\n\n# 复制文件cp wgcf-profile.conf /etc/wireguard/wgcf.conf# 启动wg-quick up wgcf# 测试# IPv4 Only VPScurl -6 ip.p3terx.com# IPv6 Only VPScurl -4 ip.p3terx.com# 关闭wg-quick down wgcf\n\n\n开机启动\n\n# 启用守护进程sudo systemctl start wg-quick@wgcf# 设置开机启动sudo systemctl enable wg-quick@wgcf\n\n参考资料\nwarp\nnet\nCloudflare WARP 给 Linux VPS 云服务器添加原生 IPv4&#x2F;IPv6 双栈网络\nDebian Linux VPS 服务器 WireGuard 安装教程\n\n","categories":["VPS"],"tags":["VPS"]},{"title":"Cloudflare设置DDNS","url":"/pages/15723b0a/","content":"Caddy自建ip查询\n配置DNS的A和AAAA的解析\n编辑/etc/caddy/Caddyfile\n\nipv4.xxx.com, ipv6.xxx.com &#123;\ttemplates\trespond &quot;&#123;&#123;.RemoteIP&#125;&#125;&quot;&#125;\n\nDDNS脚本编辑/root/.cf/cf-ddns.sh\n#!/bin/bash# CHANGE THESEauth_token=&quot;xxx&quot; # found in cloudflare account settingszone_name=&quot;xxx.com&quot;record_name=&quot;xxx.xxx.com&quot;# MAYBE CHANGE THESEip=$(curl -s http://ipv4.xxx.com)ip_file=&quot;.cf/ip.txt&quot;id_file=&quot;.cf/cloudflare.ids&quot;log_file=&quot;.cf/cloudflare.log&quot;# LOGGERlog() &#123;    if [ &quot;$1&quot; ]; then        echo -e &quot;[$(date)] - $1&quot; &gt;&gt; $log_file    fi&#125;# SCRIPT STARTlog &quot;Check Initiated&quot;if [ -f $ip_file ]; then    old_ip=$(cat $ip_file)    if [ $ip == $old_ip ]; then        echo &quot;IP has not changed.&quot;        exit 0    fifiif [ -f $id_file ] &amp;&amp; [ $(wc -l $id_file | cut -d &quot; &quot; -f 1) == 2 ]; then    zone_identifier=$(head -1 $id_file)    record_identifier=$(tail -1 $id_file)else    zone_identifier=$(curl -s -X GET &quot;https://api.cloudflare.com/client/v4/zones?name=$zone_name&quot; -H &quot;Authorization: Bearer $auth_token&quot; -H &quot;Content-Type: application/json&quot; | grep -Po &#x27;(?&lt;=&quot;id&quot;:&quot;)[^&quot;]*&#x27; | head -1 )    record_identifier=$(curl -s -X GET &quot;https://api.cloudflare.com/client/v4/zones/$zone_identifier/dns_records?name=$record_name&quot; -H &quot;Authorization: Bearer $auth_token&quot; -H &quot;Content-Type: application/json&quot;  | grep -Po &#x27;(?&lt;=&quot;id&quot;:&quot;)[^&quot;]*&#x27;)    echo &quot;$zone_identifier&quot; &gt; $id_file    echo &quot;$record_identifier&quot; &gt;&gt; $id_filefiupdate=$(curl -s -X PUT &quot;https://api.cloudflare.com/client/v4/zones/$zone_identifier/dns_records/$record_identifier&quot; -H &quot;Authorization: Bearer $auth_token&quot; -H &quot;Content-Type: application/json&quot; --data &quot;&#123;\\&quot;id\\&quot;:\\&quot;$zone_identifier\\&quot;,\\&quot;type\\&quot;:\\&quot;A\\&quot;,\\&quot;name\\&quot;:\\&quot;$record_name\\&quot;,\\&quot;content\\&quot;:\\&quot;$ip\\&quot;&#125;&quot;)if [[ $update == *&quot;\\&quot;success\\&quot;:false&quot;* ]]; then    message=&quot;API UPDATE FAILED. DUMPING RESULTS:\\n$update&quot;    log &quot;$message&quot;    echo -e &quot;$message&quot;    exit 1 else    message=&quot;IP changed to: $ip&quot;    echo &quot;$ip&quot; &gt; $ip_file    log &quot;$message&quot;    echo &quot;$message&quot;fi\n设置输入crontab -e，添加\n// 无日志*/2 * * * * /root/cf-v4-ddns.sh &gt;/dev/null 2&gt;&amp;1//有日志*/2 * * * * /root/cf-v4-ddns.sh &gt;&gt; /root/.cf/cf-ddns.log 2&gt;&amp;1\n\n参考\nCloudflare 一键 DDNS 脚本及 使用教程\n\n","categories":["软路由"],"tags":["DDNS"]},{"title":"部署/cppla/ServerStatus探针","url":"/pages/230dbe43/","content":"开源项目地址\nServerStatus\n\n部署服务器端\n安装服务\n\ndocker run -d --restart=always --name=serverstatus -v /root/.docker/serverstatus/serverstatus-config.json:/ServerStatus/server/config.json -v /root/.docker/serverstatus/serverstatus-monthtraffic:/usr/share/nginx/html/json -p 127.0.0.1:8080:80 -p 35601:35601 cppla/serverstatus\n\n\n配置服务器文件，/root/.docker/serverstatus/serverstatus-config.json\n\n&#123;    &quot;servers&quot;: [        &#123;            &quot;username&quot;: &quot;自定义用户名&quot;,            &quot;name&quot;: &quot;服务器名称&quot;,            &quot;type&quot;: &quot;kvm&quot;,            &quot;host&quot;: &quot;host1&quot;,            &quot;location&quot;: &quot;中国&quot;,            &quot;password&quot;: &quot;自定义密码&quot;,            &quot;monthstart&quot;: 1        &#125;    ],    &quot;watchdog&quot;: [        &#123;            &quot;name&quot;: &quot;cpu high warning&quot;,            &quot;rule&quot;: &quot;cpu&gt;90&amp;load_1&gt;3&quot;,            &quot;interval&quot;: 600,            &quot;callback&quot;: &quot;https://yourSMSurl&quot;        &#125;,        &#123;            &quot;name&quot;: &quot;memory high warning&quot;,            &quot;rule&quot;: &quot;(memory_used/memory_total)*100&gt;90&quot;,            &quot;interval&quot;: 300,            &quot;callback&quot;: &quot;https://yourSMSurl&quot;        &#125;,        &#123;            &quot;name&quot;: &quot;offline warning&quot;,            &quot;rule&quot;: &quot;online4=0&amp;online6=0&quot;,            &quot;interval&quot;: 600,            &quot;callback&quot;: &quot;https://yourSMSurl&quot;        &#125;,        &#123;            &quot;name&quot;: &quot;you can parse an expression combining any known field&quot;,            &quot;rule&quot;: &quot;load_5&gt;3&quot;,            &quot;interval&quot;: 900,            &quot;callback&quot;: &quot;https://yourSMSurl&quot;        &#125;    ]&#125;\n\n\n配置https(caddy)，编辑/etc/caddy/Caddyfile\n\n域名 &#123;\treverse_proxy localhost:8080&#125;\n部署客户端\nkvm开启bbr（可选）\n\necho &quot;net.core.default_qdisc=fq&quot; &gt;&gt; /etc/sysctl.confecho &quot;net.ipv4.tcp_congestion_control=bbr&quot; &gt;&gt; /etc/sysctl.confsysctl -p\n\nopenvz开启bbr（可选）\n\nwget --no-cache -O lkl-haproxy.sh https://github.com/mzz2017/lkl-haproxy/raw/master/lkl-haproxy.sh &amp;&amp; bash lkl-haproxy.sh\n\n\n新建服务服务，vim /lib/systemd/system/status-client.service\n\n\ndebian系统服务\n\n[Unit]Description=ServerStatus-ClientAfter=network.target[Service]ExecStart=/usr/bin/python3 /root/.tool/client-linux.pyExecReload=/bin/kill -HUP $MAINPIDRestart=on-failure[Install]WantedBy=multi-user.target\n\n安装alpine系统依赖\n\napk add python3 procps iproute2 coreutils\n\nalpine系统服务，vim /etc/init.d/status-client\n\n#!/sbin/openrc-run# Copyright 1999-2018 Gentoo Foundation# Distributed under the terms of the GNU General Public License v2command=&quot;/usr/bin/python3 /root/.tool/client-linux.py&quot;command_background=truepidfile=&quot;/run/$&#123;RC_SVCNAME&#125;.pid&quot;depend() &#123;\tneed net&#125;\n\n设置权限\n\nchmod +x /etc/init.d/status-client\n\n其他\n网络测试脚本\n\nwget -qO- bench.sh | bash\n\ntcp&#x2F;http&#x2F;docker监听\n\ndocker run -d --restart=always -p 3001:3001 -v /mnt/disk/docker/kuma:/app/data --name uptime-kuma louislam/uptime-kuma:1\n\n\n\n\n","categories":["VPS"],"tags":["VPS"]},{"title":"Nat VPS自定义端口搭建Zerotier Moon","url":"/pages/3bdd7537/","content":"环境\nNAT VPS\nUbuntu 22.04\n\n安装安装Zerotiercurl -s https://install.zerotier.com | sudo bash\n自定义端口,编辑/var/lib/zerotier-one/local.conf\nNAT映射的时候，内网和公网的端口需要一样\n\n&#123;    &quot;settings&quot;: &#123;        &quot;primaryPort&quot;: 10109    &#125;&#125;\n搭建Moon\n创建节点文件\n\ncd /var/lib/zerotier-one/zerotier-idtool initmoon identity.public &gt;&gt; moon.json\n\n修改文件信息moon.json的&quot;stableEndpoints&quot;信息\n\n&quot;stableEndpoints&quot;: [&quot;公网IP/端口&quot;]\n\n生成节点文件\n\nzerotier-idtool genmoon moon.json\n\n启动\n\nmkdir moons.dmv 000000*.moon moons.d/systemctl restart zerotier-one\n参考\nZerotier安装\nZerotier配置文档\n\n","categories":["VPS"],"tags":["VPS"]},{"title":"Nat-VPS动态IP搭建Zerotier-Moon","url":"/pages/4e72e020/","content":"\n通过定时任务，不断轮训ip，对比ip是否变更，然后通过脚本更新moon节点文件，实现动态ip搭建moon节点\n\n环境\nDebian 11\n\n网络测试\n使用前建议使用iperf3测试服务器端口映射是否有问题\n\n\n服务器\n\niperf3 -s -p 端口\n\n客户端\n\n# 测试tcp链接iperf3-darwin -c 服务器ip -b 7M -p 端口# 客户端发udp包，服务器端接收iperf3-darwin -u -c 服务器ip -b 7M -p 端口# 客户端接收，服务器端发udp包iperf3-darwin -u -c 服务器ip -b 7M -p 端口 -R\n\n自定义端口\n便于后面脚本截取ip做对比\n\n\nZerotier自定义端口\n\n服务器端编辑脚本\n通过dns查询获取公网ip(或者curl获取)，对比本地配置文件，发现ip变更就更新moon节点文件\n\n#!/bin/bash# 通过dig获取公网ip，先检查截取的是否为ipip=$(dig +short 域名 114.114.114.114 | tail -n 1)# 本地moon节点配置文件ip_file=&quot;/var/lib/zerotier-one/moon.json&quot;# 判断ip是否变更if [ -f $ip_file ]; then    # 截取moon.json文件ip字段    old_ip=$(awk -F&#x27;[][/]&#x27; &#x27;/&quot;stableEndpoints&quot;/ &#123;gsub(/&quot;/, &quot;&quot;, $2); print $2&#125;&#x27;  $ip_file)    if [ -n &quot;$old_ip&quot; ] &amp;&amp; [ $ip == $old_ip ]; then        echo &quot;IP has not changed.&quot;        exit 0    fifi# 生成moon节点配置文件rm -rf $ip_file/usr/sbin/zerotier-idtool initmoon /var/lib/zerotier-one/identity.public &gt;&gt; $ip_file# 替换ip,生成节点文件，并重启。10109为自定义端口sed -i &#x27;/stableEndpoints/s/\\[\\]/\\[\\&quot;&#x27;$ip&#x27;\\/10109\\&quot;\\]/g&#x27; $ip_file/usr/sbin/zerotier-idtool genmoon $ip_filemkdir /var/lib/zerotier-one/moons.d/cp 000000* /var/lib/zerotier-one/moons.d/systemctl restart zerotier-one# 可选，scp拉取文件路径#mv 000000* /scpread/usrname/downloadecho $ip \n开启定时执行,crontab -e* * * * * /root/.tool/zt_tool.sh &gt; /root/.tool/zt_log\n\n客户端方法1：通过命令加入moon\n通过查询ip，和本地moons的ip对比，通过zerotier-cli orbit 加入moon\n\n#!/bin/bash# 通过dig获取公网ip，先检查截取的是否为ipip=$(dig +short 域名 114.114.114.114 | tail -n 1)ip_file=&quot;/root/.tool/moons&quot;# 通过zerotier-cli命令，获取当前moons的信息docker exec zerotier zerotier-cli listmoons &gt; $ip_file# 对比ip是否变更if [ -f $ip_file ]; then        # 截取文件ip字段，10109为自定义端口    old_ip=$(awk -F&#x27;/10109&quot;&#x27; &#x27;/10109&quot;/ &#123;gsub(/&quot;/, &quot;&quot;, $1);gsub(/ /, &quot;&quot;, $1); print $1&#125;&#x27;  $ip_file)    rm -rf $ip_file    if [ -n &quot;$old_ip&quot; ] &amp;&amp; [ $ip == $old_ip ]; then        echo &quot;IP has not changed.&quot;        exit 0    fifi# ip变更了，通过命令行加入moondocker exec zerotier zerotier-cli deorbit xxxxxx docker exec zerotier zerotier-cli orbit xxxxxx xxxxxxecho $ip\n方法2：scp&#x2F;sftp拉取moon节点文件\n通过scp&#x2F;sftp拉取服务器端moon节点文件，和本地节点文件对比，如果不同，就更新本地moon节点文件\n\n#!/bin/bash# 定义moon节点文件路径old_moon=&quot;/mnt/disk/docker/zerotier-one/moons.d/000000xxxxxx.moon&quot;new_moon=&quot;./000000xxxxxx.moon&quot;# scp拉取文件#scp -i .ssh/id_rsa -P 端口 user@hostname:~/download/000000xxxxxx.moon ./# sftp拉取文件名sftp -i .ssh/id_rsa -P 端口  user@hostname &lt;&lt; EOFget download/000000xxxxxx.moonexitEOF# 检测文件是否已经拉取,并对比文件是否变更if [ -f $new_moon ]; then    if [ -f $old_moon ]; then        result=$(cmp $old_moon $new_moon)        # 对比结果为空，说明文件没有变更        if [ -z &quot;$result&quot; ]; then            echo &quot;file has not changed.&quot;            rm $new_moon            exit 0        fi    fi    # 执行更新操作    echo &quot;file has changed.&quot;    mv $new_moon $old_moon    docker restart zerotierfi\n配置只读scp&#x2F;sftp(可选)\n禁止ssh登录，只开启scp&#x2F;sftp\n\n\n添加禁止登录用户\n\n# 添加用户useradd -d /scpread/usrname -s /sbin/nologin usrname# 修改密码passwd usrname# 创建用户文件夹mkdir -p /scpread/usrname\n\n添加ssh key校验\n\n# 创建文件夹和文件mkdir /scpread/usrname/.sshvim /scpread/usrname/.ssh/authorized_keys# 设置权限chown usrname:usrname /scpread/usrname/.ssh/chown usrname:usrname /scpread/usrname/.ssh/authorized_keys\n\n修改sshd配置文件/etc/ssh/sshd_config\n\n#Subsystem\tsftp\t/usr/lib/openssh/sftp-serverSubsystem sftp internal-sftpMatch User usrname    ChrootDirectory /scpread/usrname\n\n开启定时执行,crontab -e* * * * * /root/.tool/zt_moons.sh &gt; /root/.tool/zt_log\n\n参考\n禁止ssh登录开启scp&#x2F;sftp\nzerotier moon自动更新脚本\n\n","categories":["VPS"],"tags":["VPS"]},{"title":"iOS MapBox v10(二)修改矢量图形的几种方法","url":"/pages/5f5a1e84/","content":"环境\nMapbox v10.5.0\nXcode 14.3.1\n\n基础的图形显示标准的geojson矢量文件\n在线生成展示geojson地址 https://geojson.io\n\nshape&#123;  &quot;type&quot;: &quot;FeatureCollection&quot;,  &quot;features&quot;: [    &#123;      &quot;type&quot;: &quot;Feature&quot;,      &quot;properties&quot;: &#123;&#125;,      &quot;geometry&quot;: &#123;        &quot;coordinates&quot;: [          [            [              116.4578773269638,              61.068686560065515            ],            [              115.78931543914507,              60.457089046558025            ],            [              116.776240130686,              60.58242789052406            ],            [              116.4578773269638,              61.068686560065515            ]          ]        ],        &quot;type&quot;: &quot;Polygon&quot;      &#125;    &#125;  ]&#125;\n通过线和面显示多边形\nlayer和source的添加，需要通过初始化json添加，或者在地图加载完毕后，再通过函数添加\n\n//定义图层和数据源唯一idlet sourceId = &quot;source&quot;let fillId = &quot;layer-fill&quot;let lineId = &quot;laayer-line&quot;var source = GeoJSONSource()source.data = .emptytry? mapView.mapboxMap.style.addSource(source, id: sourceId)// 添加面var shapeFill  = FillLayer(id: fillId)shapeFill.fillColor = .constant(StyleColor(.red.withAlphaComponent(0.5)))shapeFill.source = sourceIdtry? mapView.mapboxMap.style.addLayer(shapeFill)//添加线var shapeLine  = LineLayer(id: lineId)shapeLine.source = sourceIdshapeLine.lineColor = .constant(StyleColor(.red))shapeLine.lineWidth = .constant(2)try? mapView.mapboxMap.style.addLayer(shapeLine)//赋值图形数据let geojson = ... //上面标准json字符串try? mapView.mapboxMap.style.setSourceProperty(for: sourceId, property: &quot;data&quot;, value: geojson)\n\n动态修改图形样式（表达式）\n相关表达式参考 STYLE SPECIFICATION\n\n方法一通过json包含颜色，表达式读取属性,添加颜色属性 color\nshape&#123;  &quot;type&quot;: &quot;FeatureCollection&quot;,  &quot;features&quot;: [    &#123;      &quot;type&quot;: &quot;Feature&quot;,      &quot;properties&quot;: &#123;        &quot;fillcolor&quot;: &quot;rgba(255,0,0,0.5)&quot;,        &quot;linecolor&quot;: &quot;rgba(255,0,0,1)&quot;      &#125;,      &quot;geometry&quot;: &#123;        &quot;coordinates&quot;: [          [            [              116.4578773269638,              61.068686560065515            ],            [              115.78931543914507,              60.457089046558025            ],            [              116.776240130686,              60.58242789052406            ],            [              116.4578773269638,              61.068686560065515            ]          ]        ],        &quot;type&quot;: &quot;Polygon&quot;      &#125;    &#125;  ]&#125;\n修改显示代码\nshapeFill.fillColor = .expression(Exp(.get)&#123; &quot;fillcolor&quot; &#125;)shapeLine.lineColor = .expression(Exp(.get)&#123; &quot;linecolor&quot; &#125;)\n方法二通过表达式判断图形属性，修改颜色\nshape&#123;  &quot;type&quot;: &quot;FeatureCollection&quot;,  &quot;features&quot;: [    &#123;      &quot;type&quot;: &quot;Feature&quot;,      &quot;id&quot;: &quot;123456&quot;,      &quot;properties&quot;: &#123;&#125;,      &quot;geometry&quot;: &#123;        &quot;coordinates&quot;: [          [            [              116.4578773269638,              61.068686560065515            ],            [              115.78931543914507,              60.457089046558025            ],            [              116.776240130686,              60.58242789052406            ],            [              116.4578773269638,              61.068686560065515            ]          ]        ],        &quot;type&quot;: &quot;Polygon&quot;      &#125;    &#125;  ]&#125;\n修改显示代码,选中显示颜色rgba(255,255,0,0.5)\nlet selectIds = [&quot;123456&quot;]let selExp:[Any] = [&quot;in&quot;, [&quot;id&quot;], [&quot;literal&quot;, selectIds] as [Any]]let fillcolor:[Any] = [&quot;case&quot;,                        [&quot;==&quot;, selExp,true] as [Any], &quot;rgba(255,255,0,0.5)&quot;,                        &quot;rgba(255,0,0,0.5)&quot;                      ]let linecolor:[Any] = [&quot;case&quot;,                        [&quot;==&quot;, selExp,true] as [Any], &quot;rgba(255,255,0,1)&quot;,                        &quot;rgba(255,0,0,1)&quot;                      ]try? mapView.mapboxMap.style.setLayerProperty(for:fillId , property: &quot;fill-color&quot;, value:fillcolor)try? mapView.mapboxMap.style.setLayerProperty(for:lineId , property: &quot;line-color&quot;, value:linecolor)\n通过feature-state属性修改图形样式\n修改需要基于&quot;id&quot;修改\n\n修改显示代码\nshapeFill.fillColor = .expression(Exp(.featureState)&#123; &quot;fillcolor&quot; &#125;)shapeLine.lineColor = .expression(Exp(.featureState)&#123; &quot;linecolor&quot; &#125;)\n动态修改feature-state属性\nmapView.mapboxMap.setFeatureState(sourceId: sourceId, featureId: &quot;123456&quot;, state: [&quot;fillcolor&quot;: &quot;rgba(255,0,0,0.5)&quot;,&quot;linecolor&quot;: &quot;rgba(255,0,0,1)&quot;])","categories":["Mapbox"],"tags":["Mapbox","Swift","iOS"]},{"title":"iOS MapBox v10(四)HttpServiceInterface/HttpServiceInterceptorInterface拦截修改网络请求","url":"/pages/b082fa33/","content":"环境\nMapbox v10.5.0\nXcode 14.3.1\n\nHttpServiceInterface自定义网络请求设置网络请求类MapboxCommon.HttpServiceFactory.setUserDefinedForCustom(HttpServiceInterface)\n实现网络请求类MapboxCommon.HttpServiceFactory.getInstance()返回的是自定义请求类，所以不能直接返回网络请求\nclass CustomHttpServiceInterface:HttpServiceInterface&#123;    public func setInterceptorForInterceptor(_ interceptor: HttpServiceInterceptorInterface?) &#123;            &#125;        public func setMaxRequestsPerHostForMax(_ max: UInt8) &#123;            &#125;        public func request(for request: HttpRequest, callback: @escaping HttpResponseCallback) -&gt; UInt64 &#123;            &#125;        public func cancelRequest(forId id: UInt64, callback: @escaping ResultCallback) &#123;            &#125;        public func supportsKeepCompression() -&gt; Bool &#123;            &#125;        public func download(for options: DownloadOptions, callback: @escaping DownloadStatusCallback) -&gt; UInt64 &#123;            &#125;    &#125;\n\nHttpServiceInterceptorInterface拦截修改网络请求设置网络请求代理MapboxCommon.HttpServiceFactory.getInstance().setInterceptorForInterceptor(HttpServiceInterceptorInterface)\n\n实现网络请求代理class HttpServiceHack:HttpServiceInterceptorInterface&#123;    public func onRequest(for request: HttpRequest) -&gt; HttpRequest &#123;        //修改请求        return request    &#125;        public func onDownload(forDownload download: DownloadOptions) -&gt; DownloadOptions &#123;        return download    &#125;        public func onResponse(for response: HttpResponse) -&gt; HttpResponse &#123;        //修改返回        return response    &#125;&#125;\nN个瓦片涂层合并需求N个本地地图包和M个在线地图包链接，根据时间叠加，显示为一个layer图层\n实现\n自定义local:///localtiles?x={x}&amp;y={y}&amp;z={y}链接标识 (这里不能使用file:///，因为不能拦截)\n修改设置HttpServiceInterceptorInterface，在onRequest中修改HttpRequest到本地文件链接，或者在前请求图片保存为本地后，再设置本地文件链接\n因为本地图片请求，返回码是0，所以需要在onResponse中将，将返回码设置为200\n\n其他实现方式使用第三方库GCDWebServer，作为中间人，进行请求拦截，自定义返回\n","categories":["Mapbox"],"tags":["Mapbox","Swift","iOS"]},{"title":"iOS MapBox v10(三)iconOffset/iconTranslate/textOffset/textTranslate的区别","url":"/pages/256e231d/","content":"环境\nMapbox v10.5.0\nXcode 14.3.1\n\nSymbolLayer参数说明iconOffset\n图标和锚点都会偏移，而已还会根据iconSize改变大小，例如iconOffset为[10,20],iconSize为0.5,则实际偏移显示为[5,10]\n\niconTranslate\n根据标点位置偏移,锚点不偏移，而且不受iconSize影响\n\ntextOffset\n图标和锚点都会偏移,偏移单位为em，em即n倍字体高度，如果字体高度为16px,则1em=16px，具体请搜索css em 单位\n\ntextTranslate\n根据标点位置偏移,锚点不偏移\n\n参考链接\nSymbolLayer\n\n","categories":["Mapbox"],"tags":["Mapbox","Swift","iOS"]},{"title":"iOS MapBox v10(一) 本地化/无网使用","url":"/pages/236c4326/","content":"环境\nMapbox v10.5.0\nXcode 14.3.1\n\n自定义配置文件启动mapbox的默认初始化会调用mapbox://styles/mapbox/streets-v11类似的链接，实际启动后，会通过网络获取在线的json格式的配置文件，我们需要在本地自定义一份配置文件用于初始化，具体参数可以参考Style Specification\n\n这里删除了sprite是定义在线图片，我们不需要在线图片；删除glyphs是定义在线字体，当glyphs在线数据没有加载出来的时候。会导致SymbolLayer图层不会刷新数据。\n\nmapbox.json&#123;    &quot;version&quot;: 8,    &quot;name&quot;:&quot;local-mapbox&quot;,    &quot;sources&quot;: &#123;        &quot;raster-tiles-source&quot;: &#123;            &quot;type&quot;: &quot;raster&quot;,            &quot;tiles&quot;: [&quot;https://a.basemaps.cartocdn.com/light_nolabels/&#123;z&#125;/&#123;x&#125;/&#123;y&#125;.png&quot;],            &quot;tileSize&quot;:256        &#125;    &#125;,    &quot;layers&quot;: [&#123;        &quot;id&quot;: &quot;raster-tiles-layer&quot;,        &quot;type&quot;: &quot;raster&quot;,        &quot;source&quot;: &quot;raster-tiles-source&quot;    &#125;]&#125;\n加载本地字体方式\n通过初始化MapOptions类，加载本地字体，详情查看下面章节\n下载全部字体包，然后添加glyphs字段，定义到本地路径file://或者资源文件路径asset://\n\n使用本地配置文件初始化初始化的的时候，我们自定义本地字体，一定要手动指定字体，不然在不同的版本系统上，显示会不一样\n//定义本地字体let font = UIFont.systemFont(ofSize: 0,weight: .regular).familyNamelet mapOptions = MapOptions(glyphsRasterizationOptions: GlyphsRasterizationOptions(rasterizationMode: .allGlyphsRasterizedLocally, fontFamily: font))//定义本地配置文件路径let mapInitOptions = MapInitOptions(styleURI: StyleURI(url:Bundle.main.url(forResource: &quot;mapbox&quot;, withExtension: &quot;json&quot;)!))// 初始化mapView = MapView(frame: UIScreen.main.bounds, mapInitOptions: mapInitOptions)mapView.autoresizingMask = [.flexibleWidth, .flexibleHeight]\n\n","categories":["Mapbox"],"tags":["Mapbox","Swift","iOS"]}]